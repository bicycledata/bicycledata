{% extends "layout.html" %}
{% set title = device.name %}

{% block section %}
{% with messages = get_flashed_messages() %}
{% if messages %}
<section>
  <h4>Notification</h4>
  <ul class="alt">
    {% for message in messages %}
    <li>{{ message }}</li>
    {% endfor %}
  </ul>
</section>
{% endif %}
{% endwith %}

<section id="banner">
  <div class="content">
    <header>
      {% if device.online %}
      <h1><span class="icon solid fa-server" style="color: green;"></span> <a href="/v2/devices/{{ device.ident }}">{{
          device.name }}</a></h1>
      {% else %}
      <h1><span class="icon solid fa-server" style="color: red;"></span> <a href="/v2/devices/{{ device.ident }}">{{
          device.name }}</a></h1>
      {% endif %}
    </header>
    <table>
      <tr>
        <th>Start</th>
        <td>{{ session.start }}</td>
      </tr>
      <tr>
        <th>End</th>
        <td>{{ session.end }}</td>
      </tr>
      <tr>
        <th>Duration</th>
        <td>{{ session.duration }}</td>
      </tr>
      <tr>
        <th>Distance</th>
        <td>{{ session.distance }}</td>
      </tr>
    </table>

    <section>
      <h2>Data</h2>
      <ul>
        {% for sensor in sensors %}
        <li><a href="/v2/devices/{{ device.ident }}/sessions/{{ session.name }}/sensors/{{ sensor }}"
            class="button icon solid fa-download">{{ sensor }}</a></li>
        {% endfor %}
      </ul>
    </section>

  </div>
  {% if gps_track and gps_track|length > 1 %}
  <div id="map" style="height: 400px; width: 100%; margin-bottom: 1em;"></div>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    var gpsTrack = {{ gps_track| tojson }};
    if (gpsTrack.length > 1) {
      var map = L.map('map');
      var latlngs = gpsTrack.map(function (pt) { return [pt[0], pt[1]]; });
      var bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
      var polyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);
      L.marker(latlngs[0]).addTo(map).bindPopup('Start').openPopup();
      L.marker(latlngs[latlngs.length - 1]).addTo(map).bindPopup('End');
    }
  </script>
  {% else %}
  <span class="image object">
    <img src="{{ device.image }}" alt="" />
  </span>
  {% endif %}
</section>

<!-- Session Info form -->
<section>
  <h2>Session Info</h2>
  <form method="post" action="">
    <div class="row gtr-uniform">
      <div class="col-4 col-12-small">
        <label for="battery_start"><strong>Battery Start (%)</strong></label>
        <input type="number" id="battery_start" name="battery_start" min="0" max="100" step="1"
          value="{{ session_front.battery_start if session_front.battery_start is defined else '' }}" />
      </div>
      <div class="col-4 col-12-small">
        <label for="battery_end"><strong>Battery End (%)</strong></label>
        <input type="number" id="battery_end" name="battery_end" min="0" max="100" step="1"
          value="{{ session_front.battery_end if session_front.battery_end is defined else '' }}" />
      </div>
      <div class="col-4 col-12-small">
        <label for="people_joined"><strong>People Joined</strong></label>
        <input type="number" id="people_joined" name="people_joined" min="0" max="100" step="1"
          value="{{ session_front.people_joined if session_front.people_joined is defined else '' }}" />
      </div>
      <div class="col-12">
        <label for="notes"><strong>Notes</strong></label>
        <textarea id="notes" name="notes" rows="8" style="min-height:220px; width:100%; box-sizing:border-box;"
          placeholder="Enter additional session notes">{{ session_body }}</textarea>
      </div>
      <div class="col-12">
        <ul class="actions">
          <li><button type="submit" class="button primary">Update</button></li>
        </ul>
      </div>
    </div>
  </form>
</section>

{% if button_durations and button_durations|length > 0 %}
<section>
  <h2>Button Press Durations Histogram</h2>
  <canvas id="buttonHistogram" width="600" height="300"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript">
    // Prepare histogram bins
    var durations = {{ button_durations | tojson | safe }};
    // Define bin size and range
    var binSize = 0.2;
    var maxDuration = Math.max.apply(null, durations);
    var binCount = Math.ceil(maxDuration / binSize);
    var bins = Array(binCount).fill(0);
    durations.forEach(function (d) {
      var idx = Math.min(Math.floor(d / binSize), binCount - 1);
      bins[idx]++;
    });
    var labels = bins.map(function (_, i) { return (i * binSize).toFixed(1) + '-' + ((i + 1) * binSize).toFixed(1) + 's'; });
    var ctx = document.getElementById('buttonHistogram').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Count',
          data: bins,
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Duration (seconds)' } },
          y: { title: { display: true, text: 'Count' }, beginAtZero: true }
        }
      }
    });
  </script>
</section>
{% endif %}

{% if lidar_distance and lidar_distance|length > 0 %}
<section>
  <h2>Lidar Distance Histogram</h2>
  <canvas id="lidarHistogram" width="600" height="300"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript">
    // Prepare histogram bins
    var durations = {{ lidar_distance | tojson | safe }};
    // Define bin size and range
    var binSize = 25.0;
    var maxDuration = 700.0;
    var binCount = Math.ceil(maxDuration / binSize);
    var bins = Array(binCount).fill(0);
    durations.forEach(function (d) {
      var idx = Math.min(Math.floor(d / binSize), binCount - 1);
      bins[idx]++;
    });
    var labels = bins.map(function (_, i) { return (i * binSize).toFixed(1) + '-' + ((i + 1) * binSize).toFixed(1) + 'cm'; });
    var ctx = document.getElementById('lidarHistogram').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Count',
          data: bins,
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Distance (cm)' } },
          y: { title: { display: true, text: 'Count' }, beginAtZero: true }
        }
      }
    });
  </script>
</section>
{% endif %}

<!-- Config file content -->
<div class="col-6 col-12-small">
  <label for="config"><strong>Config file</strong></label>
  <pre id="config"
    style="background:#f4f4f4; padding:1em; border-radius:4px; max-height:300px; overflow:auto;">{{ config }}</pre>
</div>

{%if log %}
<!-- Log file content -->
<div class="col-6 col-12-small">
  <label for="log"><strong>Log file</strong></label>
  <pre id="log"
    style="background:#f4f4f4; padding:1em; border-radius:4px; max-height:300px; overflow:auto;">{{ log }}</pre>
</div>
{% endif %}

{% endblock %}
